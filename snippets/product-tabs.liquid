{% comment %}
  产品页面 Tab 组件
  使用方式: {% render 'product-tabs', block: block, section: section, product: product %}
{% endcomment %}

{%- liquid
  # 统计属于当前 tab 容器的子标签页数量
  assign tab_children = section.blocks | where: "type", "tab_content"
  assign has_children = false
  assign child_count = 0
  
  for child_block in tab_children
    if child_block.settings.parent_tab_id == block.id
      assign has_children = true
      assign child_count = child_count | plus: 1
    endif
  endfor
-%}

{%- if has_children -%}
  <div
    class="product-tabs-root"
    style="
      --tabs-active-bg: {{ block.settings.tab_active_bg | default: '#e6eef9' }};
      --tabs-active-text: {{ block.settings.tab_active_text | default: '#185ee0' }};
      --tabs-inactive-text: {{ block.settings.tab_inactive_text | default: '#111111' }};
    "
    data-tabs-id="{{ block.id }}"
    {{ block.shopify_attributes }}
  >
    {% comment %} Tab 按钮列表 {% endcomment %}
    <div class="product-tabs-header" role="tablist" aria-label="Product Information Tabs">
      <span class="product-tabs-glider" aria-hidden="true"></span>
      
      {%- assign tab_index = 0 -%}
      {%- for child_block in section.blocks -%}
        {%- if child_block.type == 'tab_content' and child_block.settings.parent_tab_id == block.id -%}
          <button
            type="button"
            role="tab"
            class="product-tab-button{% if tab_index == 0 %} is-active{% endif %}"
            data-tab-index="{{ tab_index }}"
            data-tab-id="{{ child_block.id }}"
            aria-selected="{% if tab_index == 0 %}true{% else %}false{% endif %}"
            aria-controls="panel-{{ child_block.id }}"
            id="tab-{{ child_block.id }}"
          >
            {{ child_block.settings.tab_title | default: 'Tab' | escape }}
          </button>
          {%- assign tab_index = tab_index | plus: 1 -%}
        {%- endif -%}
      {%- endfor -%}
    </div>

    {% comment %} Tab 内容面板 {% endcomment %}
    <div class="product-tabs-panels">
      {%- assign panel_index = 0 -%}
      {%- for child_block in section.blocks -%}
        {%- if child_block.type == 'tab_content' and child_block.settings.parent_tab_id == block.id -%}
          <div
            role="tabpanel"
            class="product-tab-panel{% if panel_index == 0 %} is-active{% endif %}"
            id="panel-{{ child_block.id }}"
            aria-labelledby="tab-{{ child_block.id }}"
            data-panel-index="{{ panel_index }}"
          >
            <div class="rte text-sm text-opacity">
              {%- if child_block.settings.content != blank -%}
                {{ child_block.settings.content }}
              {%- endif -%}
              {%- if child_block.settings.page.content != blank -%}
                {{ child_block.settings.page.content }}
              {%- endif -%}
              {%- if child_block.settings.liquid != blank -%}
                {{ child_block.settings.liquid }}
              {%- endif -%}
            </div>
          </div>
          {%- assign panel_index = panel_index | plus: 1 -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
{%- else -%}
  <div class="product-tabs-placeholder" {{ block.shopify_attributes }}>
    <p style="padding: 1rem; background: #f0f0f0; border-radius: 8px; text-align: center; color: #666;">
      ⚠️ 请添加"标签页内容"块，并将其"父标签页 ID"设置为: <strong>{{ block.id }}</strong>
    </p>
  </div>
{%- endif -%}

<style>
  .product-tabs-root {
    position: relative;
    width: 100%;
    margin: 1rem 0;
  }

  .product-tabs-header {
    display: flex;
    position: relative;
    justify-content: flex-start;
    background-color: transparent;
    border-radius: 99px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    gap: 10px;
    margin-bottom: 24px;
  }

  .product-tabs-header::-webkit-scrollbar {
    display: none;
  }

  .product-tab-button {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 44px;
    min-width: 105px;
    padding: 0 20px;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 99px;
    cursor: pointer;
    color: var(--tabs-inactive-text, #111111);
    background: transparent;
    border: none;
    transition: color 0.15s ease-in;
    z-index: 2;
    position: relative;
    white-space: nowrap;
  }

  .product-tab-button.is-active {
    color: var(--tabs-active-text, #185ee0);
  }

  .product-tabs-glider {
    position: absolute;
    top: 50%;
    left: 0;
    height: 44px;
    width: 0;
    background-color: var(--tabs-active-bg, rgba(24, 94, 224, 0.12));
    z-index: 1;
    border-radius: 99px;
    transition: transform 0.25s ease-out, width 0.25s ease-out;
    will-change: transform, width;
    transform: translate(0, -50%);
    pointer-events: none;
  }

  .product-tabs-panels {
    margin-top: 1.5rem;
  }

  .product-tab-panel {
    display: none;
    background: #f7f7f7;
    border-radius: 16px;
    padding: 1.5rem 1rem;
    animation: product-tab-fade-in 0.2s ease-out;
  }

  .product-tab-panel.is-active {
    display: block;
  }

  @keyframes product-tab-fade-in {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 700px) {
    .product-tabs-header {
      gap: 8px;
    }
    
    .product-tab-button {
      height: 40px;
      min-width: 90px;
      padding: 0 16px;
      font-size: 0.95rem;
    }
    
    .product-tabs-glider {
      height: 40px;
    }
  }
</style>

<script>
  (function() {
    const tabsRoot = document.querySelector('[data-tabs-id="{{ block.id }}"]');
    if (!tabsRoot) return;

    const buttons = tabsRoot.querySelectorAll('.product-tab-button');
    const panels = tabsRoot.querySelectorAll('.product-tab-panel');
    const glider = tabsRoot.querySelector('.product-tabs-glider');
    const header = tabsRoot.querySelector('.product-tabs-header');

    function updateGlider(activeButton) {
      if (!glider || !activeButton) return;
      
      const buttonRect = activeButton.getBoundingClientRect();
      const headerRect = header.getBoundingClientRect();
      const offsetLeft = activeButton.offsetLeft;
      
      glider.style.width = buttonRect.width + 'px';
      glider.style.transform = `translate(${offsetLeft}px, -50%)`;
    }

    function switchTab(index) {
      buttons.forEach((btn, i) => {
        const isActive = i === index;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive);
      });

      panels.forEach((panel, i) => {
        panel.classList.toggle('is-active', i === index);
      });

      updateGlider(buttons[index]);
    }

    // 初始化滑块位置
    const activeButton = tabsRoot.querySelector('.product-tab-button.is-active');
    if (activeButton) {
      updateGlider(activeButton);
    }

    // 监听按钮点击
    buttons.forEach((button, index) => {
      button.addEventListener('click', () => {
        switchTab(index);
      });
    });

    // 监听窗口大小变化
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const activeBtn = tabsRoot.querySelector('.product-tab-button.is-active');
        if (activeBtn) updateGlider(activeBtn);
      }, 150);
    });
  })();
</script>

